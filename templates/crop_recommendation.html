{% extends "base.html" %}

{% block title %}Crop Recommendation - Farmer's Assistant{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2 class="text-center mb-4">
            <i class="fas fa-leaf text-success"></i> Crop Recommendation Tool
        </h2>
        <p class="text-center text-muted mb-5">
            Get personalized crop suggestions based on your soil and weather conditions
        </p>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-seedling"></i> Enter Your Field Conditions
                </h5>
            </div>
            <div class="card-body">
                <form id="cropForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="n" class="form-label">
                                <i class="fas fa-atom"></i> Nitrogen (N)
                            </label>
                            <input type="number" class="form-control" id="n" name="n" 
                                   placeholder="Enter nitrogen level (kg/ha)" step="0.1" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="p" class="form-label">
                                <i class="fas fa-atom"></i> Phosphorus (P)
                            </label>
                            <input type="number" class="form-control" id="p" name="p" 
                                   placeholder="Enter phosphorus level (kg/ha)" step="0.1" required>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="k" class="form-label">
                                <i class="fas fa-atom"></i> Potassium (K)
                            </label>
                            <input type="number" class="form-control" id="k" name="k" 
                                   placeholder="Enter potassium level (kg/ha)" step="0.1" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="temperature" class="form-label">
                                <i class="fas fa-thermometer-half"></i> Temperature
                            </label>
                            <input type="number" class="form-control" id="temperature" name="temperature" 
                                   placeholder="Enter temperature (Â°C)" step="0.1" required>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="humidity" class="form-label">
                                <i class="fas fa-tint"></i> Humidity
                            </label>
                            <input type="number" class="form-control" id="humidity" name="humidity" 
                                   placeholder="Enter humidity (%)" step="0.1" min="0" max="100" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="ph" class="form-label">
                                <i class="fas fa-vial"></i> pH Level
                            </label>
                            <input type="number" class="form-control" id="ph" name="ph" 
                                   placeholder="Enter pH level (0-14)" step="0.1" min="0" max="14" required>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="rainfall" class="form-label">
                                <i class="fas fa-cloud-rain"></i> Rainfall
                            </label>
                            <input type="number" class="form-control" id="rainfall" name="rainfall" 
                                   placeholder="Enter rainfall (mm)" step="0.1" required>
                        </div>
                    </div>
                    
                    <div class="text-center">
                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="fas fa-magic"></i> Get Crop Recommendation
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4" id="results" style="display: none;">
    <div class="col-12">
        <div class="card result-card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-bar"></i> Recommendation Results
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-success">Recommended Crop:</h6>
                        <h3 id="recommendedCrop" class="text-success fw-bold"></h3>
                        <p class="text-muted">Confidence: <span id="confidence"></span>%</p>
                    </div>
                    <div class="col-md-6">
                        <h6>Top 3 Crop Options:</h6>
                        <ol id="topCrops" class="list-group list-group-flush">
                        </ol>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.getElementById('cropForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        showLoading();
        
        const formData = {
            nitrogen: document.getElementById('n').value,
            phosphorus: document.getElementById('p').value,
            potassium: document.getElementById('k').value,
            temperature: document.getElementById('temperature').value,
            humidity: document.getElementById('humidity').value,
            ph: document.getElementById('ph').value,
            rainfall: document.getElementById('rainfall').value
        };
        
        try {
            const response = await fetch('/predict_crop', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            });
            
            const result = await response.json();
            
            if (result.error) {
                showAlert(result.error, 'danger');
            } else {
                // Display results
                document.getElementById('recommendedCrop').textContent = result.recommended_crop;
                document.getElementById('confidence').textContent = (result.confidence * 100).toFixed(1);
                
                // Top 3 crops
                const topCropsList = document.getElementById('topCrops');
                topCropsList.innerHTML = '';
                result.top_3_crops.forEach((crop, index) => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item d-flex justify-content-between align-items-center';
                    li.innerHTML = `
                        ${crop}
                        <span class="badge bg-success rounded-pill">${(result.top_3_confidences[index] * 100).toFixed(1)}%</span>
                    `;
                    topCropsList.appendChild(li);
                });
                
                document.getElementById('results').style.display = 'block';
                showAlert('Crop recommendation generated successfully!', 'success');
            }
        } catch (error) {
            showAlert('Error generating recommendation. Please try again.', 'danger');
        }
        
        hideLoading();
    });
</script>
{% endblock %}